<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>G3W War Dashboard</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; background: #0f1115; color: #e7e7e7; }
    h1 { margin: 0 0 10px; font-size: 20px; }
    .muted { color: #a8b0bd; }
    .card { background: #151a22; border: 1px solid #222a35; border-radius: 10px; padding: 12px; margin: 10px 0 16px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    select, input { background: #0f1115; color: #e7e7e7; border: 1px solid #2a3443; border-radius: 8px; padding: 6px 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #222a35; padding: 8px 6px; vertical-align: top; }
    th { text-align: left; color: #c9d2e0; font-weight: 600; }
    tr:hover td { background: rgba(255,255,255,0.02); }
    /* Wyraźniejsze Zwycięstwo / Porażka (delikatne tło całego wiersza) */
    tr.row-win td { background: rgba(46, 204, 113, 0.06); }
    tr.row-loss td { background: rgba(231, 76, 60, 0.06); }
    tr.row-win:hover td { background: rgba(46, 204, 113, 0.09); }
    tr.row-loss:hover td { background: rgba(231, 76, 60, 0.09); }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #2a3443; font-size: 12px; }
    .ok { border-color: rgba(46, 204, 113, 0.6); }
    .bad { border-color: rgba(231, 76, 60, 0.6); }
    .warn { border-color: rgba(241, 196, 15, 0.7); }
    details > summary { cursor: pointer; }
    pre { background: #0f1115; border: 1px solid #2a3443; border-radius: 10px; padding: 10px; overflow: auto; }
    .small { font-size: 12px; }
    .right { text-align: right; }
    .toggle { background: transparent; border: 1px solid #2a3443; color: #e7e7e7; border-radius: 8px; padding: 4px 8px; cursor: pointer; }
    .toggle:hover { background: rgba(255,255,255,0.03); }

    /* Average table row toggle */
    .avg-row { cursor: pointer; }
    .avg-row:hover { background: rgba(255,255,255,0.025); }

    /* Szczegoly w tabeli srednich rozwijane sa kliknieciem w caly wiersz */
    .details-row td { background: rgba(255,255,255,0.015); }
    .btn { background: transparent; border: 1px solid #2a3443; color: #e7e7e7; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
    .btn:hover { background: rgba(255,255,255,0.03); }

    /* Średnie graczy – rozwijane szczegóły */
    .player-name { font: inherit; color: #e7e7e7; }
    .details-row td { padding-top: 6px; padding-bottom: 10px; }
    .points-detail { padding-left: 18px; }
    .points-label { margin-right: 8px; }
    .points-chips { display: inline-flex; flex-wrap: wrap; gap: 6px; vertical-align: middle; }
    .pts-chip {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #2a3443;
      background: rgba(255,255,255,0.02);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #d7deea;
    }

    /* Zmiana pozycji w rankingu średniej (wpływ ostatniej wojny) */
    .rank-up { color: rgba(46, 204, 113, 0.95); font-weight: 700; }
    .rank-down { color: rgba(231, 76, 60, 0.95); font-weight: 700; }
    .rank-same { color: #a8b0bd; }
  </style>
</head>
<body>
  <h1>G3W War Dashboard</h1>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div><b>Wojny</b></div>
      <div class="muted" id="warsCount">Ładowanie…</div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="muted">Filtry:</div>
      <select id="filterResult">
        <option value="">Wynik: wszystkie</option>
        <option value="Zwycięstwo">Zwycięstwo</option>
        <option value="Porażka">Porażka</option>
      </select>
      <select id="filterMode">
        <option value="">Tryb: wszystkie</option>
      </select>
      <select id="filterOpponent">
        <option value="">Przeciwnik: wszyscy</option>
      </select>
      <div class="muted">Sort:</div>
      <select id="sortBy">
        <option value="date_desc">Data (najnowsze)</option>
        <option value="result">Wynik (Zwycięstwa na górze)</option>
        <option value="mode">Tryb (A→Z)</option>
        <option value="diff_desc">Różnica (malejąco)</option>
      </select>
    </div>

    <div style="overflow:auto; margin-top:10px;">
      <table id="warsTable">
        <thead>
          <tr>
            <th></th>
            <th>Data</th>
            <th>Wynik</th>
            <th class="right">Różnica</th>
            <th>Tryb</th>
            <th class="right">My</th>
            <th>Przeciwnik</th>
            <th class="right">Ich wynik</th>
            <th class="right">Poza rosterem</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div><b>Średnia graczy</b></div>
      <div class="muted">z ostatnich</div>
      <select id="avgX"></select>
      <div class="muted">wojen</div>
    </div>
    <div style="overflow:auto; margin-top:10px;">
      <table id="rosterTable">
        <thead>
          <tr>
            <th class="right">#</th>
            <th class="right" title="Jak ostatnia wojna wpłynęła na pozycję w rankingu średniej">Δ</th>
            <th>Nick (roster)</th>
            <th class="right">Średnia</th>
            <th class="right">Suma</th>
            <th class="right">Wojen z pkt</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="margin-top:10px; display:flex; justify-content:flex-start;">
      <button id="rosterToggleBtn" class="btn" style="display:none;">Pokaż więcej</button>
    </div>
  </div>

<script>
  const fmtDate = (ts) => {
    try {
      const d = new Date(ts * 1000);
      // Only date (no time) for the "Data" column.
      return d.toLocaleDateString('pl-PL', { year: 'numeric', month: '2-digit', day: '2-digit' });
    } catch (e) { return String(ts); }
  };

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  async function loadAll() {
    const [warsResp, rosterResp] = await Promise.all([
      fetch('/api/wars'),
      fetch('/api/roster')
    ]);
    const warsData = await warsResp.json();
    const rosterData = await rosterResp.json();
    const wars = Array.isArray(warsData) ? warsData : (warsData.wars || []);
    const roster = Array.isArray(rosterData) ? rosterData : (rosterData.roster || []);
    window.__ALL_WARS__ = wars;
    window.__ROSTER__ = roster;
    initFilters(wars);
    renderWars();
    renderRosterAverages();
  }

  function uniqSorted(arr) {
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),'pl'));
  }

  function initFilters(wars) {
    const modeSel = document.getElementById('filterMode');
    const oppSel = document.getElementById('filterOpponent');

    const modes = uniqSorted(wars.map(w => (w.mode || '').trim() || '-'));
    const opps = uniqSorted(wars.map(w => (w.opponent_alliance || '').trim() || '-'));

    modeSel.innerHTML = '<option value="">Tryb: wszystkie</option>';
    for (const m of modes) {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      modeSel.appendChild(opt);
    }

    oppSel.innerHTML = '<option value="">Przeciwnik: wszyscy</option>';
    for (const o of opps) {
      const opt = document.createElement('option');
      opt.value = o;
      opt.textContent = o;
      oppSel.appendChild(opt);
    }

    document.getElementById('filterResult').onchange = renderWars;
    modeSel.onchange = renderWars;
    oppSel.onchange = renderWars;
    document.getElementById('sortBy').onchange = renderWars;
  }

  function applyFiltersAndSort(wars) {
    const fRes = document.getElementById('filterResult').value;
    const fMode = document.getElementById('filterMode').value;
    const fOpp = document.getElementById('filterOpponent').value;
    const sortBy = document.getElementById('sortBy').value;

    let out = wars.slice();
    if (fRes) out = out.filter(w => String(w.result || '').trim() === fRes);
    if (fMode) out = out.filter(w => ((w.mode || '').trim() || '-') === fMode);
    if (fOpp) out = out.filter(w => ((w.opponent_alliance || '').trim() || '-') === fOpp);

    const keyDate = (w) => Number(w.created_at_ts || 0);
    const keyDiff = (w) => Number(w.diff || 0);
    const keyResult = (w) => (/zwyci/i.test(w.result||'') ? 1 : 0);
    const keyMode = (w) => String((w.mode||'').trim() || '-');

    if (sortBy === 'date_desc') {
      out.sort((a,b)=> keyDate(b) - keyDate(a));
    } else if (sortBy === 'diff_desc') {
      out.sort((a,b)=> keyDiff(b) - keyDiff(a) || keyDate(b)-keyDate(a));
    } else if (sortBy === 'result') {
      out.sort((a,b)=> keyResult(b) - keyResult(a) || keyDiff(b)-keyDiff(a) || keyDate(b)-keyDate(a));
    } else if (sortBy === 'mode') {
      out.sort((a,b)=> keyMode(a).localeCompare(keyMode(b),'pl') || keyDate(b)-keyDate(a));
    }

    return out;
  }

  function renderWars() {
    const wars = Array.isArray(window.__ALL_WARS__) ? window.__ALL_WARS__ : [];
    const filtered = applyFiltersAndSort(wars);
    const tbody = document.querySelector('#warsTable tbody');
    tbody.innerHTML = '';

    document.getElementById('warsCount').textContent = `Wojny: ${filtered.length} / ${wars.length}`;

    for (const w of filtered) {
      const res = w.result || '';
      const isWin = /zwyci/i.test(res);
      const isLoss = /(poraż|przegr)/i.test(res);
      const isDraw = /remis/i.test(res);
      const pillClass = isWin ? 'ok' : (isLoss ? 'bad' : '');
      const diff = Number(w.diff || 0);
      const oorN = Number(w.out_of_roster_count || 0);

      const mode = (w.mode || '').trim() || '-';
      const opp = (w.opponent_alliance || '').trim() || '-';

      const detailsLines = (w.players || []).map(p => {
        const status = p.status || 'ok';
        let note = '';
        if (status === 'unknown') note = ' (UNKNOWN)';
        else if (status === 'out_of_roster') note = ' (poza rosterem)';
        return `[${String(p.rank).padStart(2,'0')}] ${p.name} — ${p.points}${note}`;
      }).join('\n');

      const tr = document.createElement('tr');
      tr.className = 'war-row' + (isWin ? ' row-win' : (isLoss ? ' row-loss' : ''));

      const btn = document.createElement('button');
      btn.className = 'toggle';
      btn.type = 'button';
      btn.textContent = '▶';

      const detailsTr = document.createElement('tr');
      detailsTr.className = 'details-row';
      detailsTr.style.display = 'none';
      const wid = (w.war_id || '').trim();
      detailsTr.innerHTML = `<td colspan="9">
        <pre class="small">${escapeHtml(detailsLines || '')}</pre>
        ${wid ? `<div class="muted small" style="margin-top:6px;">ID wojny: <code>${escapeHtml(wid)}</code></div>` : ''}
      </td>`;

      btn.onclick = () => {
        const isOpen = detailsTr.style.display !== 'none';
        detailsTr.style.display = isOpen ? 'none' : '';
        btn.textContent = isOpen ? '▶' : '▼';
      };

      tr.innerHTML = `
        <td></td>
        <td>${escapeHtml(fmtDate(w.created_at_ts || 0))}</td>
        <td><span class="pill ${pillClass}">${escapeHtml(res)}</span></td>
        <td class="right">${escapeHtml((diff >= 0 ? '+' : '') + diff)}</td>
        <td>${escapeHtml(mode)}</td>
        <td class="right">${escapeHtml(w.our_score ?? '')}</td>
        <td>${escapeHtml(opp)}</td>
        <td class="right">${escapeHtml((w.opponent_score ?? w.enemy_score ?? '') + '')}</td>
        <td class="right">${oorN ? `<span class="pill warn">${oorN}</span>` : '0'}</td>
      `;
      tr.children[0].appendChild(btn);
      tbody.appendChild(tr);
      tbody.appendChild(detailsTr);
    }
  }

  function renderRosterAverages() {
    const wars = Array.isArray(window.__ALL_WARS__) ? window.__ALL_WARS__ : [];
    const roster = Array.isArray(window.__ROSTER__) ? window.__ROSTER__ : [];
    const sel = document.getElementById('avgX');
    const n = wars.length;
    sel.innerHTML = '';
    const max = Math.max(1, n);
    for (let i=1; i<=max; i++) {
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = String(i);
      sel.appendChild(opt);
    }
    sel.value = String(Math.min(5, max));

    let expanded = false;
    const render = () => {
      const x = Number(sel.value || 1);
      // Średnia ma być liczona z X NAJŚWIEŻSZYCH wojen (po dacie dodania screenów na Discordzie),
      // niezależnie od aktualnego sortowania/filtrów tabeli na stronie.
      const warsSorted = wars.slice().sort((a, b) => Number(b.created_at_ts || 0) - Number(a.created_at_ts || 0));
      const slice = warsSorted.slice(0, x);

      // Compare current ranking (last X wars) with the previous window (wars 2..X+1).
      // This gives "how the last war affected the player's position".
      const prevSlice = warsSorted.slice(1, x + 1);

      const buildRowsForSlice = (warSlice, wantPoints) => {
        // For averages we count only wars where the player is present in the list.
        // (We do NOT divide by X if the player did not participate.)
        const statsByName = new Map();
        for (const name of roster) {
          statsByName.set(name, { sum: 0, count: 0, points: wantPoints ? Array(x).fill(null) : null });
        }
        for (let i = 0; i < warSlice.length; i++) {
          const w = warSlice[i];
          const map = new Map();
          for (const p of (w.players || [])) {
            map.set(p.name, Number(p.points || 0));
          }
          for (const name of roster) {
            const s = statsByName.get(name);
            if (!s) continue;
            if (map.has(name)) {
              const pts = Number(map.get(name) || 0);
              if (wantPoints && s.points) s.points[i] = pts;
              s.sum += pts;
              s.count += 1;
            }
          }
        }
        return roster.map(name => {
          const s = statsByName.get(name) || { sum: 0, count: 0, points: wantPoints ? Array(x).fill(null) : null };
          const avg = s.count ? (s.sum / s.count) : 0;
          return { name, avg, sum: s.sum, warsCount: s.count, points: wantPoints ? (s.points || Array(x).fill(null)) : null };
        }).sort((a,b)=> (b.avg - a.avg) || (b.sum - a.sum) || a.name.localeCompare(b.name));
      };

      const rows = buildRowsForSlice(slice, true);
      const prevRows = (prevSlice.length === x) ? buildRowsForSlice(prevSlice, false) : null;

      const prevRankByName = new Map();
      if (prevRows) {
        prevRows.forEach((r, idx) => prevRankByName.set(r.name, idx + 1));
      }

      const trendHtml = (currentRank, name) => {
        if (!prevRows) return '<span class="rank-same">–</span>';
        const prevRank = prevRankByName.get(name);
        if (!prevRank) return '<span class="rank-same">–</span>';
        const diff = prevRank - currentRank; // positive => moved up
        if (diff > 0) return `<span class="rank-up" title="Poprzednio #${prevRank}">▲${diff}</span>`;
        if (diff < 0) return `<span class="rank-down" title="Poprzednio #${prevRank}">▼${Math.abs(diff)}</span>`;
        return `<span class="rank-same" title="Bez zmiany (poprzednio #${prevRank})">•0</span>`;
      };

      const top = rows.slice(0, 5);
      const rest = rows.slice(5);

      const tbody = document.querySelector('#rosterTable tbody');
      tbody.innerHTML = '';
      expanded = false;

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        const detailsTr = document.createElement('tr');
        detailsTr.className = 'details-row';
        detailsTr.style.display = 'none';

        const isMore = idx >= 5;
        if (isMore) {
          tr.classList.add('more-row');
          detailsTr.classList.add('more-row');
          tr.style.display = 'none';
          detailsTr.style.display = 'none';
        }

        // Details row (hidden by default). We only expand it by clicking the arrow next to the nick.
        const tdDetails = document.createElement('td');
        tdDetails.colSpan = 6;
        tdDetails.className = 'small muted';

        const detailWrap = document.createElement('div');
        detailWrap.className = 'points-detail';

        const label = document.createElement('span');
        label.className = 'points-label';
        label.textContent = 'Pkt z wojen:';

        const chips = document.createElement('span');
        chips.className = 'points-chips';
        for (const v of (r.points || [])) {
          const chip = document.createElement('span');
          chip.className = 'pts-chip';
          chip.textContent = (v === null || v === undefined) ? '-' : String(v);
          chips.appendChild(chip);
        }

        detailWrap.appendChild(label);
        detailWrap.appendChild(chips);
        tdDetails.appendChild(detailWrap);
        detailsTr.appendChild(tdDetails);

        // Nick. Row click toggles details.
        const nameSpan = document.createElement('span');
        nameSpan.className = 'player-name';
        nameSpan.textContent = r.name;

        // Track open/closed state so "Pokaż więcej" does not auto-expand detail rows.
        detailsTr.dataset.open = '0';

        const setOpen = (open) => {
          detailsTr.dataset.open = open ? '1' : '0';
          detailsTr.style.display = open ? '' : 'none';
          tr.setAttribute('aria-expanded', open ? 'true' : 'false');
        };

        const toggle = () => {
          const open = detailsTr.dataset.open === '1';
          setOpen(!open);
        };

        tr.innerHTML = `
          <td class="right">${idx + 1}</td>
          <td class="right small">${trendHtml(idx + 1, r.name)}</td>
          <td></td>
          <td class="right">${r.avg.toFixed(1)}</td>
          <td class="right">${r.sum}</td>
          <td class="right">${r.warsCount}/${x}</td>
        `;
        tr.classList.add('avg-row');
        tr.setAttribute('role', 'button');
        tr.setAttribute('tabindex', '0');
        tr.setAttribute('aria-expanded', 'false');

        tr.addEventListener('click', (e) => {
          // Allow text selection without toggling if user is selecting.
          if (window.getSelection && String(window.getSelection()).length > 0) return;
          toggle();
        });
        tr.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggle();
          }
        });

        // Nick
        tr.children[2].appendChild(nameSpan);

        // Ensure collapsed by default
        setOpen(false);

        tbody.appendChild(tr);
        tbody.appendChild(detailsTr);
      });

      const btn = document.getElementById('rosterToggleBtn');
      if (rest.length > 0) {
        btn.style.display = '';
        btn.textContent = 'Pokaż więcej';
        btn.title = `Pokaż ${rest.length} pozostałych`;
        btn.onclick = () => {
          expanded = !expanded;
          // Show/hide only the main rows. When revealing "more" rows we keep ALL detail rows collapsed
          // (user must click the small arrow to open details).
          const moreMainRows = document.querySelectorAll('#rosterTable tbody tr.more-row:not(.details-row)');
          for (const tr of moreMainRows) {
            if (!expanded) {
              tr.style.display = 'none';
              const detailsTr = tr.nextElementSibling;
              if (detailsTr && detailsTr.classList.contains('details-row')) {
                detailsTr.style.display = 'none';
                detailsTr.dataset.open = '0';
              }
              tr.setAttribute('aria-expanded', 'false');
            } else {
              tr.style.display = '';
              // Force-collapse details for newly revealed rows.
              const detailsTr = tr.nextElementSibling;
              if (detailsTr && detailsTr.classList.contains('details-row')) {
                detailsTr.style.display = 'none';
                detailsTr.dataset.open = '0';
              }
              tr.setAttribute('aria-expanded', 'false');
            }
          }
          btn.textContent = expanded ? 'Pokaż mniej' : 'Pokaż więcej';
        };
      } else {
        btn.style.display = 'none';
        btn.onclick = null;
      }
    };

    sel.onchange = render;
    render();
  }

  loadAll().catch(err => {
    console.error(err);
    document.getElementById('warsCount').textContent = 'Błąd ładowania danych.';
  });
</script>
</body>
</html>
