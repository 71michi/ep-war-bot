<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>G3W War Dashboard</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; background: #0f1115; color: #e7e7e7; }
    h1 { margin: 0 0 10px; font-size: 20px; }
    .muted { color: #a8b0bd; }
    .card { background: #151a22; border: 1px solid #222a35; border-radius: 10px; padding: 12px; margin: 10px 0 16px; }
    .table-wrap { overflow: auto; margin-top: 10px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    select, input { background: #0f1115; color: #e7e7e7; border: 1px solid #2a3443; border-radius: 8px; padding: 6px 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #222a35; padding: 8px 6px; vertical-align: top; }
    th { text-align: left; color: #c9d2e0; font-weight: 600; }
    tr:hover td { background: rgba(255,255,255,0.02); }
    /* Wyraźniejsze Zwycięstwo / Porażka (delikatne tło całego wiersza) */
    tr.row-win td { background: rgba(46, 204, 113, 0.06); }
    tr.row-loss td { background: rgba(231, 76, 60, 0.06); }
    tr.row-win:hover td { background: rgba(46, 204, 113, 0.09); }
    tr.row-loss:hover td { background: rgba(231, 76, 60, 0.09); }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #2a3443; font-size: 12px; }
    .ok { border-color: rgba(46, 204, 113, 0.6); }
    .bad { border-color: rgba(231, 76, 60, 0.6); }
    .warn { border-color: rgba(241, 196, 15, 0.7); }
    details > summary { cursor: pointer; }
    pre { background: #0f1115; border: 1px solid #2a3443; border-radius: 10px; padding: 10px; overflow: auto; }
    .small { font-size: 12px; }
    .right { text-align: right; }
    /* (legacy) button toggle styles kept for other places */
    .toggle { background: transparent; border: 1px solid #2a3443; color: #e7e7e7; border-radius: 8px; padding: 4px 8px; cursor: pointer; }
    .toggle:hover { background: rgba(255,255,255,0.03); }

    /* Wars list: click whole row */
    .war-row { cursor: pointer; }
    .war-row:hover td { background: rgba(255,255,255,0.02); }

    /* Mobile one-line summary for wars (Data + Wynik + Różnica + Przeciwnik + skrót trybu) */
    .war-line { display: none; align-items: center; gap: 10px; min-width: 0; }
    .war-line .w-date { flex: 0 0 auto; color: #e7e7e7; }
    .war-line .w-diff { flex: 0 0 auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .war-line .w-opp {
      flex: 1 1 auto;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #c9d2e0;
      font-size: 12px;
    }
    .war-line .w-mode-short {
      flex: 0 0 auto;
      min-width: 32px;
      text-align: right;
      font-size: 12px;
      font-weight: 700;
      color: #d7deea;
      opacity: 0.95;
    }

    .w-mode-wrap { position: relative; display: inline-flex; align-items: center; }
    .mode-icon-btn { display: none; border: 0; background: transparent; padding: 0; margin-left: 6px; cursor: pointer; }
    .mode-icon-btn:active { transform: scale(0.98); }
    .mode-icon { width: 20px; height: 20px; border-radius: 50%; box-shadow: 0 0 0 1px #1c2533; }
    .mode-tooltip { position: absolute; right: 0; top: 26px; z-index: 50; display: none; padding: 6px 8px; border-radius: 8px;
      background: rgba(15,17,21,0.98); border: 1px solid #273140; color: #e7e7e7; font-size: 12px; white-space: nowrap; box-shadow: 0 10px 25px rgba(0,0,0,0.35); }
    .w-mode-wrap.open .mode-tooltip { display: block; }

    .w-date-only { display: inline; }

    /* Average table row toggle */
    .avg-row { cursor: pointer; }
    .avg-row:hover { background: rgba(255,255,255,0.025); }

    /* Szczegoly w tabeli srednich rozwijane sa kliknieciem w caly wiersz */
    .details-row td { background: rgba(255,255,255,0.015); }
    .btn { background: transparent; border: 1px solid #2a3443; color: #e7e7e7; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
    .btn:hover { background: rgba(255,255,255,0.03); }

    /* Średnie graczy – rozwijane szczegóły */
    .player-name { font: inherit; color: #e7e7e7; }
    .details-row td { padding-top: 6px; padding-bottom: 10px; }
    .points-detail { padding-left: 18px; }
    .points-label { margin-right: 8px; }
    .points-chips { display: inline-flex; flex-wrap: wrap; gap: 6px; vertical-align: middle; }
    .pts-chip {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #2a3443;
      background: rgba(255,255,255,0.02);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #d7deea;
    }

    /* Zmiana pozycji w rankingu średniej (wpływ ostatniej wojny) */
    .rank-up { color: rgba(46, 204, 113, 0.95); font-weight: 700; }
    .rank-down { color: rgba(231, 76, 60, 0.95); font-weight: 700; }
    .rank-same { color: #a8b0bd; }

    /* Licznik W-D-L przy nagłówku "Wojny" */
    .count-win { color: rgba(46, 204, 113, 0.95); font-weight: 700; }
    .count-draw { color: #a8b0bd; font-weight: 700; }
    .count-loss { color: rgba(231, 76, 60, 0.95); font-weight: 700; }

    /* Wojny: ładniejszy widok listy graczy w szczegółach */
    .war-details { display: grid; gap: 10px; width: 100%; max-width: 100%; box-sizing: border-box; text-align: left; }
    .war-details * { box-sizing: border-box; }
    .war-details-header { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .war-meta { display: inline-flex; gap: 6px; align-items: center; }
    .war-meta code { background: rgba(255,255,255,0.03); border: 1px solid #2a3443; padding: 1px 6px; border-radius: 999px; }
    .players-wrap { overflow: auto; }
    .players-table { width: 100%; border-collapse: collapse; border: 1px solid #222a35; border-radius: 10px; overflow: hidden; }
    .players-table th, .players-table td { padding: 8px 10px; border-bottom: 1px solid #222a35; }
    .players-table th { background: rgba(255,255,255,0.02); color: #c9d2e0; font-weight: 650; }
    .players-table tr:hover td { background: rgba(255,255,255,0.02); }
    /* Podświetlenie wierszy ze statusem (UNKNOWN / poza rosterem) */
    .players-table tr.row-unknown td { background: rgba(241, 196, 15, 0.06); }
    .players-table tr.row-oor td { background: rgba(241, 196, 15, 0.04); }
    .players-table tr.row-unknown:hover td { background: rgba(241, 196, 15, 0.09); }
    .players-table tr.row-oor:hover td { background: rgba(241, 196, 15, 0.06); }

    /* Mobile players list for war details */
    .players-mobile { display: none; }
    .players-mobile .player-line {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid #222a35;
      border-radius: 12px;
      background: rgba(255,255,255,0.01);
    }
    .players-mobile .player-line.row-unknown { background: rgba(241, 196, 15, 0.06); }
    .players-mobile .player-line.row-oor { background: rgba(241, 196, 15, 0.04); }
    .players-mobile .rank-badge { flex: 0 0 auto; min-width: 34px; text-align: center; }
    .players-mobile .pname { flex: 1 1 auto; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .players-mobile .pts { flex: 0 0 auto; min-width: 56px; text-align: right; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .players-mobile .pstatus { flex: 0 0 auto; min-width: 92px; text-align: right; white-space: nowrap; display: flex; justify-content: flex-end; }
    .rank-badge {
      display: inline-flex;
      min-width: 26px;
      justify-content: center;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #2a3443;
      background: rgba(255,255,255,0.02);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #d7deea;
    }
    .pts {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      color: #e7e7e7;
    }
    .status-cell { white-space: nowrap; }
    .status-pill { margin-left: 6px; }

    /* Wojny: przycisk Pokaż więcej/mniej */
    .wars-toggle-wrap { margin-top: 10px; display: flex; justify-content: flex-start; }

    /* Nagłówek: bilans W-R-P */
    .wins { color: rgba(46, 204, 113, 0.95); font-weight: 700; }
    .draws { color: #a8b0bd; font-weight: 700; }
    .losses { color: rgba(231, 76, 60, 0.95); font-weight: 700; }

    /* Mobile: brak przewijania lewo-prawo (wojny jako karty + szczegóły full-width) */
    @media (max-width: 640px) {
      body { margin: 10px; }
      .card { padding: 10px; }

      /* Na mobile nie przewijamy poziomo kontenera tabel */
      .table-wrap { overflow: visible; }

      /* Wars list on mobile: one-line summary (no horizontal scroll) */
      #warsTable thead { display: none; }
      #warsTable, #warsTable tbody, #warsTable tr { display: block; width: 100%; }
      #warsTable tr.war-row { border: 1px solid #222a35; border-radius: 10px; margin: 10px 0; overflow: hidden; }
      /* show only the first cell with a compact one-line summary */
      #warsTable tr.war-row td { display: none; border: 0; padding: 10px 12px; }
      #warsTable tr.war-row td:first-child { display: block; }
      #warsTable td::before { content: ''; }
      .war-line { display: flex; }

      /* On mobile show mode icon instead of abbreviation */
      .w-mode-short { display: none; }
      .mode-icon-btn { display: inline-flex; }
      .w-date-only { display: none; }

      /* Wiersz szczegółów jako blok pod kartą */
      #warsTable tr.details-row { display: block; margin: -6px 0 14px; }
      #warsTable tr.details-row td { display: block; padding: 8px 0 0; border: 0; }
      #warsTable tr.details-row td::before { content: ''; }

      .war-details-header { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: start; }
      .war-details-header .war-meta { grid-column: 1 / -1; }
      .war-details-header .pill { font-size: 11px; padding: 2px 7px; }
      .players-wrap { overflow: visible; }

      /* War details players list on mobile uses div-based layout (no table hacks for Safari) */
      .players-table { display: none; }
      .players-mobile { display: flex; flex-direction: column; gap: 8px; }
    }
  </style>
</head>
<body>
  <h1>G3W War Dashboard</h1>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div><b>Wojny</b> <span class="muted" id="warsSummary" title="Bilans: zwycięstwa–remisy–porażki"></span></div>
      <div class="muted" id="warsCount">Ładowanie…</div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="muted">Filtry:</div>
      <select id="filterResult">
        <option value="">Wynik: wszystkie</option>
        <option value="Zwycięstwo">Zwycięstwo</option>
        <option value="Porażka">Porażka</option>
      </select>
      <select id="filterMode">
        <option value="">Tryb: wszystkie</option>
      </select>
      <select id="filterOpponent">
        <option value="">Przeciwnik: wszyscy</option>
      </select>
      <div class="muted">Sort:</div>
      <select id="sortBy">
        <option value="date_desc">Data (najnowsze)</option>
        <option value="result">Wynik (Zwycięstwa na górze)</option>
        <option value="mode">Tryb (A→Z)</option>
        <option value="diff_desc">Różnica (malejąco)</option>
      </select>
    </div>

    <div class="table-wrap wars-wrap">
      <table id="warsTable">
        <thead>
          <tr>
            <th>Data</th>
            <th>Wynik</th>
            <th class="right">Różnica</th>
            <th>Przeciwnik</th>
            <th>Tryb</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="wars-toggle-wrap">
      <button id="warsToggleBtn" class="btn" style="display:none;">Pokaż więcej</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div><b>Średnia graczy</b></div>
      <div class="muted">z ostatnich</div>
      <select id="avgX"></select>
      <div class="muted">wojen</div>
    </div>
    <div class="table-wrap">
      <table id="rosterTable">
        <thead>
          <tr>
            <th class="right">#</th>
            <th class="right" title="Jak ostatnia wojna wpłynęła na pozycję w rankingu średniej">Δ</th>
            <th>Nick (roster)</th>
            <th class="right">Średnia</th>
            <th class="right">Suma</th>
            <th class="right">Wojen z pkt</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="margin-top:10px; display:flex; justify-content:flex-start;">
      <button id="rosterToggleBtn" class="btn" style="display:none;">Pokaż więcej</button>
    </div>
  </div>

<script>
  const fmtDate = (ts) => {
    try {
      const d = new Date(ts * 1000);
      // Only date (no time) for the "Data" column.
      return d.toLocaleDateString('pl-PL', { year: 'numeric', month: '2-digit', day: '2-digit' });
    } catch (e) { return String(ts); }
  };

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  function abbrMode(mode) {
    const m = String(mode || '').trim();
    if (!m || m === '-') return '-';
    const up = m.toUpperCase();
    const map = {
      'LEPSZY ATAK': 'LA',
      'SZTURM': 'SZ',
      'ŻAR Z NIEBA': 'ZZN',
      'ZAR Z NIEBA': 'ZZN',
      'KRWAWA WOJNA': 'KW',
    };
    if (map[up]) return map[up];

    // Fallback: take first letters of words (including short ones like "Z").
    const parts = up.split(/\s+/).filter(Boolean);
    const ab = parts.map(p => p[0]).join('');
    return ab.slice(0, 4);
  }


  function normalizeModeKey(s) {
    return String(s || '')
      .trim()
      .toLowerCase()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu, '')
      .replace(/\s+/g, ' ');
  }

  const MODE_ICON_MAP = (() => {
    // Keys are normalized (lowercase, no diacritics)
    const m = new Map();
    m.set(normalizeModeKey('Grad strzał'), 'icon_final_3.png');
    m.set(normalizeModeKey('Horda nieumarłych'), 'icon_final_1.png');
    m.set(normalizeModeKey('Krwawa wojna'), 'icon_final_2.png');
    m.set(normalizeModeKey('Lepszy atak'), 'icon_final_6.png');
    m.set(normalizeModeKey('Starożytny upiór'), 'icon_final_7.png');
    m.set(normalizeModeKey('Szturm'), 'icon_final_4.png');
    m.set(normalizeModeKey('Wojenne wyrównanie'), 'icon_final_8.png');
    m.set(normalizeModeKey('Żar z nieba'), 'icon_final_9.png');
    m.set(normalizeModeKey('Pole koniczyny'), 'icon_final_5.png');
    return m;
  })();

  function getModeIconSrc(modeFull) {
    const key = normalizeModeKey(modeFull);
    const file = MODE_ICON_MAP.get(key);
    const placeholder = "data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22%3E%3Crect width=%2264%22 height=%2264%22 rx=%2232%22 ry=%2232%22 fill=%22%231c2533%22/%3E%3Ctext x=%2232%22 y=%2242%22 font-size=%2234%22 text-anchor=%22middle%22 fill=%22%23e7e7e7%22 font-family=%22Arial%22%3E%3F%3C/text%3E%3C/svg%3E";
    return file ? `/static/icons/${file}` : placeholder;
  }

  // Tooltip handling: click icon to toggle, click anywhere else to close.
  function closeAllModeTooltips(exceptWrap) {
    document.querySelectorAll('.w-mode-wrap.open').forEach(w => {
      if (exceptWrap && w === exceptWrap) return;
      w.classList.remove('open');
    });
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest && e.target.closest('.mode-icon-btn');
    if (btn) {
      e.preventDefault();
      e.stopPropagation();
      const wrap = btn.closest('.w-mode-wrap');
      if (!wrap) return;
      const willOpen = !wrap.classList.contains('open');
      closeAllModeTooltips();
      if (willOpen) wrap.classList.add('open');
      return;
    }
    closeAllModeTooltips();
  });


    async function loadAll() {
    const [warsResp, rosterResp] = await Promise.all([
      fetch('/api/wars'),
      fetch('/api/roster')
    ]);
    const warsData = await warsResp.json();
    const rosterData = await rosterResp.json();
    const wars = Array.isArray(warsData) ? warsData : (warsData.wars || []);
    const roster = Array.isArray(rosterData) ? rosterData : (rosterData.roster || []);
    window.__ALL_WARS__ = wars;
    window.__ROSTER__ = roster;
    initFilters(wars);
    renderWars();
    renderRosterAverages();
  }

  function uniqSorted(arr) {
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),'pl'));
  }

  function initFilters(wars) {
    const modeSel = document.getElementById('filterMode');
    const oppSel = document.getElementById('filterOpponent');

    const modes = uniqSorted(wars.map(w => (w.mode || '').trim() || '-'));
    const opps = uniqSorted(wars.map(w => (w.opponent_alliance || '').trim() || '-'));

    modeSel.innerHTML = '<option value="">Tryb: wszystkie</option>';
    for (const m of modes) {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      modeSel.appendChild(opt);
    }

    oppSel.innerHTML = '<option value="">Przeciwnik: wszyscy</option>';
    for (const o of opps) {
      const opt = document.createElement('option');
      opt.value = o;
      opt.textContent = o;
      oppSel.appendChild(opt);
    }

    document.getElementById('filterResult').onchange = renderWars;
    modeSel.onchange = renderWars;
    oppSel.onchange = renderWars;
    document.getElementById('sortBy').onchange = renderWars;
  }

  function applyFiltersAndSort(wars) {
    const fRes = document.getElementById('filterResult').value;
    const fMode = document.getElementById('filterMode').value;
    const fOpp = document.getElementById('filterOpponent').value;
    const sortBy = document.getElementById('sortBy').value;

    let out = wars.slice();
    if (fRes) out = out.filter(w => String(w.result || '').trim() === fRes);
    if (fMode) out = out.filter(w => ((w.mode || '').trim() || '-') === fMode);
    if (fOpp) out = out.filter(w => ((w.opponent_alliance || '').trim() || '-') === fOpp);

    const keyDate = (w) => Number(w.created_at_ts || 0);
    const keyDiff = (w) => Number(w.diff || 0);
    const keyResult = (w) => (/zwyci/i.test(w.result||'') ? 1 : 0);
    const keyMode = (w) => String((w.mode||'').trim() || '-');

    if (sortBy === 'date_desc') {
      out.sort((a,b)=> keyDate(b) - keyDate(a));
    } else if (sortBy === 'diff_desc') {
      out.sort((a,b)=> keyDiff(b) - keyDiff(a) || keyDate(b)-keyDate(a));
    } else if (sortBy === 'result') {
      out.sort((a,b)=> keyResult(b) - keyResult(a) || keyDiff(b)-keyDiff(a) || keyDate(b)-keyDate(a));
    } else if (sortBy === 'mode') {
      out.sort((a,b)=> keyMode(a).localeCompare(keyMode(b),'pl') || keyDate(b)-keyDate(a));
    }

    return out;
  }

  function renderWars() {
    const wars = Array.isArray(window.__ALL_WARS__) ? window.__ALL_WARS__ : [];
    const filtered = applyFiltersAndSort(wars);
    const tbody = document.querySelector('#warsTable tbody');
    tbody.innerHTML = '';

    // Bilans W-D-L liczony ze wszystkich wojen (niezależnie od filtrów)
    const wins = wars.filter(w => /zwyci/i.test(String(w.result || ''))).length;
    const draws = wars.filter(w => /remis/i.test(String(w.result || ''))).length;
    const losses = wars.filter(w => /(poraż|przegr)/i.test(String(w.result || ''))).length;
    const summaryEl = document.getElementById('warsSummary');
    if (summaryEl) {
      summaryEl.innerHTML = `(<span class="count-win">${wins}</span>-<span class="count-draw">${draws}</span>-<span class="count-loss">${losses}</span>)`;
    }

    document.getElementById('warsCount').textContent = `Wojny: ${filtered.length} / ${wars.length}`;

    // Domyślnie pokazuj tylko 5 ostatnich wojen. Stan "Pokaż więcej" utrzymujemy
    // do kliknięcia "Pokaż mniej" lub odświeżenia strony.
    const toggleBtn = document.getElementById('warsToggleBtn');
    const showAll = !!window.__WARS_EXPANDED__;
    const list = showAll ? filtered : filtered.slice(0, 5);
    if (toggleBtn) {
      if (filtered.length > 5) {
        toggleBtn.style.display = '';
        toggleBtn.textContent = showAll ? 'Pokaż mniej' : 'Pokaż więcej';
        toggleBtn.onclick = () => {
          window.__WARS_EXPANDED__ = !showAll;
          renderWars();
        };
      } else {
        toggleBtn.style.display = 'none';
      }
    }

    for (const w of list) {
      const res = w.result || '';
      const isWin = /zwyci/i.test(res);
      const isLoss = /(poraż|przegr)/i.test(res);
      const isDraw = /remis/i.test(res);
      const pillClass = isWin ? 'ok' : (isLoss ? 'bad' : '');
      const diff = Number(w.diff || 0);
      const oorN = Number(w.out_of_roster_count || 0);

      const modeFull = (w.mode || '').trim() || '-';
      const modeShort = abbrMode(modeFull);
      const opp = (w.opponent_alliance || '').trim() || '-';

      const players = Array.isArray(w.players) ? w.players : [];

      const mkPlayersRowHtml = (p) => {
        const status = String(p.status || 'ok');
        let statusHtml = '';
        let rowClass = '';
        if (status === 'unknown') { statusHtml = `<span class="pill warn status-pill">UNKNOWN</span>`; rowClass = 'row-unknown'; }
        else if (status === 'out_of_roster') { statusHtml = `<span class="pill warn status-pill">Poza rosterem</span>`; rowClass = 'row-oor'; }

        const r = String(p.rank ?? '').trim();
        const rankNum = r ? Number(r) : NaN;
        const rank = r ? String(r).padStart(2,'0') : '--';
        const name = escapeHtml(p.name ?? '');
        const ptsNum = Number(p.points || 0);
        const pts = escapeHtml(p.points ?? '');

        return `
          <tr class="${rowClass}" data-rank="${Number.isFinite(rankNum) ? rankNum : ''}" data-pts="${Number.isFinite(ptsNum) ? ptsNum : ''}" data-name="${escapeHtml(p.name ?? '')}">
            <td class="player-col-rank right" data-label="#"><span class="rank-badge">${escapeHtml(rank)}</span></td>
            <td class="player-col-name" data-label="Gracz">${name}</td>
            <td class="player-col-pts right" data-label="Pkt"><span class="pts">${pts}</span></td>
            <td class="player-col-status status-cell" data-label="Status">${statusHtml || '<span class="muted small">—</span>'}</td>
          </tr>
        `;
      };

      const mkPlayersLineHtml = (p) => {
        const status = String(p.status || 'ok');
        let statusHtml = '<span class="muted small">—</span>';
        let rowClass = '';
        if (status === 'unknown') { statusHtml = `<span class="pill warn">UNKNOWN</span>`; rowClass = 'row-unknown'; }
        else if (status === 'out_of_roster') { statusHtml = `<span class="pill warn">Poza rosterem</span>`; rowClass = 'row-oor'; }

        const r = String(p.rank ?? '').trim();
        const rankNum = r ? Number(r) : NaN;
        const rank = r ? String(r).padStart(2,'0') : '--';
        const name = escapeHtml(p.name ?? '');
        const ptsNum = Number(p.points || 0);
        const pts = escapeHtml(p.points ?? '');

        return `
          <div class="player-line ${rowClass}" data-rank="${Number.isFinite(rankNum) ? rankNum : ''}" data-pts="${Number.isFinite(ptsNum) ? ptsNum : ''}" data-name="${escapeHtml(p.name ?? '')}">
            <span class="rank-badge">${escapeHtml(rank)}</span>
            <span class="pname">${name}</span>
            <span class="pts">${pts}</span>
            <span class="pstatus">${statusHtml}</span>
          </div>
        `;
      };

      const buildPlayersRowsHtml = (arr) => arr.map(mkPlayersRowHtml).join('');
      const buildPlayersMobileHtml = (arr) => arr.map(mkPlayersLineHtml).join('');
      const playersRowsHtml = buildPlayersRowsHtml(players);
      const playersMobileHtml = buildPlayersMobileHtml(players);

      const tr = document.createElement('tr');
      tr.className = 'war-row' + (isWin ? ' row-win' : (isLoss ? ' row-loss' : ''));

      const detailsTr = document.createElement('tr');
      detailsTr.className = 'details-row';
      detailsTr.style.display = 'none';
      const wid = (w.war_id || '').trim();
      const scoreOpp = (w.opponent_score ?? w.enemy_score ?? '');
      const diffText = (diff >= 0 ? '+' : '') + diff;
      const metaId = wid ? `<span class="war-meta muted small">ID: <code>${escapeHtml(wid)}</code></span>` : '';

      detailsTr.innerHTML = `<td colspan="5">
        <div class="war-details">
          <div class="war-details-header">
            ${metaId}
            <span class="pill ${pillClass}">${escapeHtml(res)}</span>
            <span class="pill">Tryb: ${escapeHtml(modeFull)}</span>
            <span class="pill">My: ${escapeHtml(w.our_score ?? '')}</span>
            <span class="pill">Ich: ${escapeHtml(scoreOpp)}</span>
            <span class="pill">Różnica: ${escapeHtml(diffText)}</span>
            <span class="pill">Przeciwnik: ${escapeHtml(opp)}</span>
          </div>
          <div class="players-wrap">
            <table class="players-table">
              <thead>
                <tr>
                  <th class="right" data-sort="rank" title="Kliknij, aby sortować">#</th>
                  <th data-sort="name" title="Kliknij, aby sortować">Gracz</th>
                  <th class="right" data-sort="pts" title="Kliknij, aby sortować">Pkt</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${players.length ? playersRowsHtml : `<tr><td colspan="4" class="muted small">Brak listy graczy w tej wojnie.</td></tr>`}
              </tbody>
            </table>
            <div class="players-mobile">
              ${players.length ? playersMobileHtml : `<div class="muted small">Brak listy graczy w tej wojnie.</div>`}
            </div>
          </div>
        </div>
      </td>`;

      // Sortowanie listy graczy w szczegółach wojny
      if (players.length) {
        const table = detailsTr.querySelector('.players-table');
        const body = table ? table.querySelector('tbody') : null;
        const heads = table ? table.querySelectorAll('thead th[data-sort]') : [];
        let sortKey = 'rank';
        let sortDir = 'asc';

        const sortPlayers = (key, dir) => {
          const arr = players.slice();
          const mul = dir === 'asc' ? 1 : -1;
          arr.sort((a, b) => {
            if (key === 'rank') return mul * ((Number(a.rank||0) - Number(b.rank||0)) || String(a.name||'').localeCompare(String(b.name||''),'pl'));
            if (key === 'pts') return mul * ((Number(a.points||0) - Number(b.points||0)) || (Number(a.rank||0) - Number(b.rank||0)));
            return mul * String(a.name||'').localeCompare(String(b.name||''),'pl') || (Number(a.rank||0) - Number(b.rank||0));
          });
          return arr;
        };

        const renderPlayers = () => {
          const arr = sortPlayers(sortKey, sortDir);
          if (body) body.innerHTML = buildPlayersRowsHtml(arr);
          const mob = detailsTr.querySelector('.players-mobile');
          if (mob) mob.innerHTML = buildPlayersMobileHtml(arr);
        };

        heads.forEach(th => {
          th.style.cursor = 'pointer';
          th.onclick = () => {
            const key = th.getAttribute('data-sort');
            if (!key) return;
            if (sortKey === key) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
            else {
              sortKey = key;
              sortDir = (key === 'pts') ? 'desc' : 'asc';
            }
            renderPlayers();
          };
        });
      }

      const dateText = escapeHtml(fmtDate(w.created_at_ts || 0));
      // Compact one-line summary for mobile (only first cell is shown there).
      // Desktop shows separate columns.
      tr.innerHTML = `
        <td data-label="Data">
          <div class="war-line">
            <span class="w-date">${dateText}</span>
            <span class="pill ${pillClass}">${escapeHtml(res)}</span>
            <span class="w-diff">${escapeHtml((diff >= 0 ? '+' : '') + diff)}</span>
            <span class="w-opp">${escapeHtml(opp)}</span>
            <span class="w-mode-wrap" data-mode-full="${escapeHtml(modeFull)}">
              <button class="mode-icon-btn" type="button" aria-label="Tryb wojny">
                <img class="mode-icon" src="${escapeHtml(getModeIconSrc(modeFull))}" alt="${escapeHtml(modeFull)}"/>
              </button>
              <span class="w-mode-short" title="${escapeHtml(modeFull)}">${escapeHtml(modeShort)}</span>
              <span class="mode-tooltip" role="tooltip">${escapeHtml(modeFull)}</span>
            </span>
          </div>
          <span class="w-date-only">${dateText}</span>
        </td>
        <td data-label="Wynik"><span class="pill ${pillClass}">${escapeHtml(res)}</span></td>
        <td class="right" data-label="Różnica">${escapeHtml((diff >= 0 ? '+' : '') + diff)}</td>
        <td data-label="Przeciwnik">${escapeHtml(opp)}</td>
        <td data-label="Tryb" title="${escapeHtml(modeFull)}">${escapeHtml(modeShort)}</td>
      `;

      // Toggle details by clicking the whole war row.
      // Do not toggle when clicking inside an already-open details block.
      const toggleDetails = () => {
        const isOpen = detailsTr.style.display !== 'none';
        detailsTr.style.display = isOpen ? 'none' : '';
      };
      tr.onclick = toggleDetails;
      tr.onkeydown = (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleDetails();
        }
      };
      tr.setAttribute('tabindex', '0');
      detailsTr.onclick = (e) => e.stopPropagation();
      tbody.appendChild(tr);
      tbody.appendChild(detailsTr);
    }
  }

  function renderRosterAverages() {
    const wars = Array.isArray(window.__ALL_WARS__) ? window.__ALL_WARS__ : [];
    const roster = Array.isArray(window.__ROSTER__) ? window.__ROSTER__ : [];
    const sel = document.getElementById('avgX');
    const n = wars.length;
    sel.innerHTML = '';
    const max = Math.max(1, n);
    for (let i=1; i<=max; i++) {
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = String(i);
      sel.appendChild(opt);
    }
    sel.value = String(Math.min(5, max));

    let expanded = false;
    const render = () => {
      const x = Number(sel.value || 1);
      // Średnia ma być liczona z X NAJŚWIEŻSZYCH wojen (po dacie dodania screenów na Discordzie),
      // niezależnie od aktualnego sortowania/filtrów tabeli na stronie.
      const warsSorted = wars.slice().sort((a, b) => Number(b.created_at_ts || 0) - Number(a.created_at_ts || 0));
      const slice = warsSorted.slice(0, x);

      // Compare current ranking (last X wars) with the previous window (wars 2..X+1).
      // This gives "how the last war affected the player's position".
      const prevSlice = warsSorted.slice(1, x + 1);

      const buildRowsForSlice = (warSlice, wantPoints) => {
        // For averages we count only wars where the player is present in the list.
        // (We do NOT divide by X if the player did not participate.)
        const statsByName = new Map();
        for (const name of roster) {
          statsByName.set(name, { sum: 0, count: 0, points: wantPoints ? Array(x).fill(null) : null });
        }
        for (let i = 0; i < warSlice.length; i++) {
          const w = warSlice[i];
          const map = new Map();
          for (const p of (w.players || [])) {
            map.set(p.name, Number(p.points || 0));
          }
          for (const name of roster) {
            const s = statsByName.get(name);
            if (!s) continue;
            if (map.has(name)) {
              const pts = Number(map.get(name) || 0);
              if (wantPoints && s.points) s.points[i] = pts;
              s.sum += pts;
              s.count += 1;
            }
          }
        }
        return roster.map(name => {
          const s = statsByName.get(name) || { sum: 0, count: 0, points: wantPoints ? Array(x).fill(null) : null };
          const avg = s.count ? (s.sum / s.count) : 0;
          return { name, avg, sum: s.sum, warsCount: s.count, points: wantPoints ? (s.points || Array(x).fill(null)) : null };
        }).sort((a,b)=> (b.avg - a.avg) || (b.sum - a.sum) || a.name.localeCompare(b.name));
      };

      const rows = buildRowsForSlice(slice, true);
      const prevRows = (prevSlice.length === x) ? buildRowsForSlice(prevSlice, false) : null;

      const prevRankByName = new Map();
      if (prevRows) {
        prevRows.forEach((r, idx) => prevRankByName.set(r.name, idx + 1));
      }

      const trendHtml = (currentRank, name) => {
        if (!prevRows) return '<span class="rank-same">–</span>';
        const prevRank = prevRankByName.get(name);
        if (!prevRank) return '<span class="rank-same">–</span>';
        const diff = prevRank - currentRank; // positive => moved up
        if (diff > 0) return `<span class="rank-up" title="Poprzednio #${prevRank}">▲${diff}</span>`;
        if (diff < 0) return `<span class="rank-down" title="Poprzednio #${prevRank}">▼${Math.abs(diff)}</span>`;
        return `<span class="rank-same" title="Bez zmiany (poprzednio #${prevRank})">•0</span>`;
      };

      const top = rows.slice(0, 5);
      const rest = rows.slice(5);

      const tbody = document.querySelector('#rosterTable tbody');
      tbody.innerHTML = '';
      // Preserve the current "Pokaż więcej/mniej" state when changing X,
      // so the user doesn't need to re-expand the list every time.

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        const detailsTr = document.createElement('tr');
        detailsTr.className = 'details-row';
        detailsTr.style.display = 'none';

        const isMore = idx >= 5;
        if (isMore) {
          tr.classList.add('more-row');
          detailsTr.classList.add('more-row');
          // Keep "more" rows visible if the user previously clicked "Pokaż więcej".
          tr.style.display = expanded ? '' : 'none';
          detailsTr.style.display = 'none';
        }

        // Details row (hidden by default). We only expand it by clicking the arrow next to the nick.
        const tdDetails = document.createElement('td');
        tdDetails.colSpan = 6;
        tdDetails.className = 'small muted';

        const detailWrap = document.createElement('div');
        detailWrap.className = 'points-detail';

        const label = document.createElement('span');
        label.className = 'points-label';
        label.textContent = 'Pkt z wojen:';

        const chips = document.createElement('span');
        chips.className = 'points-chips';
        for (const v of (r.points || [])) {
          const chip = document.createElement('span');
          chip.className = 'pts-chip';
          chip.textContent = (v === null || v === undefined) ? '-' : String(v);
          chips.appendChild(chip);
        }

        detailWrap.appendChild(label);
        detailWrap.appendChild(chips);
        tdDetails.appendChild(detailWrap);
        detailsTr.appendChild(tdDetails);

        // Nick. Row click toggles details.
        const nameSpan = document.createElement('span');
        nameSpan.className = 'player-name';
        nameSpan.textContent = r.name;

        // Track open/closed state so "Pokaż więcej" does not auto-expand detail rows.
        detailsTr.dataset.open = '0';

        const setOpen = (open) => {
          detailsTr.dataset.open = open ? '1' : '0';
          detailsTr.style.display = open ? '' : 'none';
          tr.setAttribute('aria-expanded', open ? 'true' : 'false');
        };

        const toggle = () => {
          const open = detailsTr.dataset.open === '1';
          setOpen(!open);
        };

        tr.innerHTML = `
          <td class="right">${idx + 1}</td>
          <td class="right small">${trendHtml(idx + 1, r.name)}</td>
          <td></td>
          <td class="right">${r.avg.toFixed(1)}</td>
          <td class="right">${r.sum}</td>
          <td class="right">${r.warsCount}/${x}</td>
        `;
        tr.classList.add('avg-row');
        tr.setAttribute('role', 'button');
        tr.setAttribute('tabindex', '0');
        tr.setAttribute('aria-expanded', 'false');

        tr.addEventListener('click', (e) => {
          // Allow text selection without toggling if user is selecting.
          if (window.getSelection && String(window.getSelection()).length > 0) return;
          toggle();
        });
        tr.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggle();
          }
        });

        // Nick
        tr.children[2].appendChild(nameSpan);

        // Ensure collapsed by default
        setOpen(false);

        tbody.appendChild(tr);
        tbody.appendChild(detailsTr);
      });

      const btn = document.getElementById('rosterToggleBtn');
      if (rest.length > 0) {
        btn.style.display = '';
        btn.textContent = expanded ? 'Pokaż mniej' : 'Pokaż więcej';
        btn.title = `Pokaż ${rest.length} pozostałych`;
        btn.onclick = () => {
          expanded = !expanded;
          // Show/hide only the main rows. When revealing "more" rows we keep ALL detail rows collapsed
          // (user must click the small arrow to open details).
          const moreMainRows = document.querySelectorAll('#rosterTable tbody tr.more-row:not(.details-row)');
          for (const tr of moreMainRows) {
            if (!expanded) {
              tr.style.display = 'none';
              const detailsTr = tr.nextElementSibling;
              if (detailsTr && detailsTr.classList.contains('details-row')) {
                detailsTr.style.display = 'none';
                detailsTr.dataset.open = '0';
              }
              tr.setAttribute('aria-expanded', 'false');
            } else {
              tr.style.display = '';
              // Force-collapse details for newly revealed rows.
              const detailsTr = tr.nextElementSibling;
              if (detailsTr && detailsTr.classList.contains('details-row')) {
                detailsTr.style.display = 'none';
                detailsTr.dataset.open = '0';
              }
              tr.setAttribute('aria-expanded', 'false');
            }
          }
          btn.textContent = expanded ? 'Pokaż mniej' : 'Pokaż więcej';
        };
      } else {
        btn.style.display = 'none';
        btn.onclick = null;
      }
    };

    sel.onchange = render;
    render();
  }

  loadAll().catch(err => {
    console.error(err);
    document.getElementById('warsCount').textContent = 'Błąd ładowania danych.';
  });
</script>
</body>
</html>
