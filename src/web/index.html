<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>G3W War Dashboard</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; background: #0f1115; color: #e7e7e7; }
    h1 { margin: 0 0 10px; font-size: 20px; }
    .muted { color: #a8b0bd; }
    .card { background: #151a22; border: 1px solid #222a35; border-radius: 10px; padding: 12px; margin: 10px 0 16px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    select, input { background: #0f1115; color: #e7e7e7; border: 1px solid #2a3443; border-radius: 8px; padding: 6px 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #222a35; padding: 8px 6px; vertical-align: top; }
    th { text-align: left; color: #c9d2e0; font-weight: 600; }
    tr:hover td { background: rgba(255,255,255,0.02); }
    /* Wyraźniejsze Zwycięstwo / Porażka (delikatne tło całego wiersza) */
    tr.row-win td { background: rgba(46, 204, 113, 0.06); }
    tr.row-loss td { background: rgba(231, 76, 60, 0.06); }
    tr.row-win:hover td { background: rgba(46, 204, 113, 0.09); }
    tr.row-loss:hover td { background: rgba(231, 76, 60, 0.09); }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #2a3443; font-size: 12px; }
    .ok { border-color: rgba(46, 204, 113, 0.6); }
    .bad { border-color: rgba(231, 76, 60, 0.6); }
    .warn { border-color: rgba(241, 196, 15, 0.7); }
    details > summary { cursor: pointer; }
    pre { background: #0f1115; border: 1px solid #2a3443; border-radius: 10px; padding: 10px; overflow: auto; }
    .small { font-size: 12px; }
    .right { text-align: right; }
    .toggle { background: transparent; border: 1px solid #2a3443; color: #e7e7e7; border-radius: 8px; padding: 4px 8px; cursor: pointer; }
    .toggle:hover { background: rgba(255,255,255,0.03); }
    .details-row td { background: rgba(255,255,255,0.015); }
    .btn { background: transparent; border: 1px solid #2a3443; color: #e7e7e7; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
    .btn:hover { background: rgba(255,255,255,0.03); }
  </style>
</head>
<body>
  <h1>G3W War Dashboard</h1>
  <div class="muted small">Lista wojen jest budowana z wyników <b>zatwierdzonych</b> komendą <code>ADDWAR</code> (po <code>LISTWAR</code> + ewentualnych poprawkach) na Discordzie.</div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div><b>Wojny</b></div>
      <div class="muted" id="warsCount">Ładowanie…</div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="muted">Filtry:</div>
      <select id="filterResult">
        <option value="">Wynik: wszystkie</option>
        <option value="Zwycięstwo">Zwycięstwo</option>
        <option value="Porażka">Porażka</option>
      </select>
      <select id="filterMode">
        <option value="">Tryb: wszystkie</option>
      </select>
      <select id="filterOpponent">
        <option value="">Przeciwnik: wszyscy</option>
      </select>
      <div class="muted">Sort:</div>
      <select id="sortBy">
        <option value="date_desc">Data (najnowsze)</option>
        <option value="result">Wynik (Zwycięstwa na górze)</option>
        <option value="mode">Tryb (A→Z)</option>
        <option value="diff_desc">Różnica (malejąco)</option>
      </select>
    </div>

    <div style="overflow:auto; margin-top:10px;">
      <table id="warsTable">
        <thead>
          <tr>
            <th></th>
            <th>Data</th>
            <th>Wynik</th>
            <th class="right">Różnica</th>
            <th>Tryb</th>
            <th class="right">My</th>
            <th>Przeciwnik</th>
            <th class="right">Ich wynik</th>
            <th class="right">Poza rosterem</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div><b>Średnia graczy</b></div>
      <div class="muted">z ostatnich</div>
      <select id="avgX"></select>
      <div class="muted">wojen</div>
    </div>
    <div style="overflow:auto; margin-top:10px;">
      <table id="rosterTable">
        <thead>
          <tr>
            <th>Nick (roster)</th>
            <th class="right">Średnia</th>
            <th class="right">Suma</th>
            <th class="right">Wojen z pkt</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="margin-top:10px; display:flex; justify-content:flex-start;">
      <button id="rosterToggleBtn" class="btn" style="display:none;">Pokaż więcej</button>
    </div>
  </div>

<script>
  const fmtDate = (ts) => {
    try {
      const d = new Date(ts * 1000);
      return d.toLocaleString('pl-PL');
    } catch (e) { return String(ts); }
  };

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  async function loadAll() {
    const [warsResp, rosterResp] = await Promise.all([
      fetch('/api/wars'),
      fetch('/api/roster')
    ]);
    const warsData = await warsResp.json();
    const rosterData = await rosterResp.json();
    const wars = Array.isArray(warsData) ? warsData : (warsData.wars || []);
    const roster = Array.isArray(rosterData) ? rosterData : (rosterData.roster || []);
    window.__ALL_WARS__ = wars;
    window.__ROSTER__ = roster;
    initFilters(wars);
    renderWars();
    renderRosterAverages();
  }

  function uniqSorted(arr) {
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),'pl'));
  }

  function initFilters(wars) {
    const modeSel = document.getElementById('filterMode');
    const oppSel = document.getElementById('filterOpponent');

    const modes = uniqSorted(wars.map(w => (w.mode || '').trim() || '-'));
    const opps = uniqSorted(wars.map(w => (w.opponent_alliance || '').trim() || '-'));

    modeSel.innerHTML = '<option value="">Tryb: wszystkie</option>';
    for (const m of modes) {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      modeSel.appendChild(opt);
    }

    oppSel.innerHTML = '<option value="">Przeciwnik: wszyscy</option>';
    for (const o of opps) {
      const opt = document.createElement('option');
      opt.value = o;
      opt.textContent = o;
      oppSel.appendChild(opt);
    }

    document.getElementById('filterResult').onchange = renderWars;
    modeSel.onchange = renderWars;
    oppSel.onchange = renderWars;
    document.getElementById('sortBy').onchange = renderWars;
  }

  function applyFiltersAndSort(wars) {
    const fRes = document.getElementById('filterResult').value;
    const fMode = document.getElementById('filterMode').value;
    const fOpp = document.getElementById('filterOpponent').value;
    const sortBy = document.getElementById('sortBy').value;

    let out = wars.slice();
    if (fRes) out = out.filter(w => String(w.result || '').trim() === fRes);
    if (fMode) out = out.filter(w => ((w.mode || '').trim() || '-') === fMode);
    if (fOpp) out = out.filter(w => ((w.opponent_alliance || '').trim() || '-') === fOpp);

    const keyDate = (w) => Number(w.created_at_ts || 0);
    const keyDiff = (w) => Number(w.diff || 0);
    const keyResult = (w) => (/zwyci/i.test(w.result||'') ? 1 : 0);
    const keyMode = (w) => String((w.mode||'').trim() || '-');

    if (sortBy === 'date_desc') {
      out.sort((a,b)=> keyDate(b) - keyDate(a));
    } else if (sortBy === 'diff_desc') {
      out.sort((a,b)=> keyDiff(b) - keyDiff(a) || keyDate(b)-keyDate(a));
    } else if (sortBy === 'result') {
      out.sort((a,b)=> keyResult(b) - keyResult(a) || keyDiff(b)-keyDiff(a) || keyDate(b)-keyDate(a));
    } else if (sortBy === 'mode') {
      out.sort((a,b)=> keyMode(a).localeCompare(keyMode(b),'pl') || keyDate(b)-keyDate(a));
    }

    return out;
  }

  function renderWars() {
    const wars = Array.isArray(window.__ALL_WARS__) ? window.__ALL_WARS__ : [];
    const filtered = applyFiltersAndSort(wars);
    const tbody = document.querySelector('#warsTable tbody');
    tbody.innerHTML = '';

    document.getElementById('warsCount').textContent = `Wojny: ${filtered.length} / ${wars.length}`;

    for (const w of filtered) {
      const res = w.result || '';
      const isWin = /zwyci/i.test(res);
      const isLoss = /(poraż|przegr)/i.test(res);
      const isDraw = /remis/i.test(res);
      const pillClass = isWin ? 'ok' : (isLoss ? 'bad' : '');
      const diff = Number(w.diff || 0);
      const oorN = Number(w.out_of_roster_count || 0);

      const mode = (w.mode || '').trim() || '-';
      const opp = (w.opponent_alliance || '').trim() || '-';

      const detailsLines = (w.players || []).map(p => {
        const status = p.status || 'ok';
        let note = '';
        if (status === 'unknown') note = ' (UNKNOWN)';
        else if (status === 'out_of_roster') note = ' (poza rosterem)';
        return `[${String(p.rank).padStart(2,'0')}] ${p.name} — ${p.points}${note}`;
      }).join('\n');

      const tr = document.createElement('tr');
      tr.className = 'war-row' + (isWin ? ' row-win' : (isLoss ? ' row-loss' : ''));

      const btn = document.createElement('button');
      btn.className = 'toggle';
      btn.type = 'button';
      btn.textContent = '▶';

      const detailsTr = document.createElement('tr');
      detailsTr.className = 'details-row';
      detailsTr.style.display = 'none';
      const wid = (w.war_id || '').trim();
      detailsTr.innerHTML = `<td colspan="9">
        <pre class="small">${escapeHtml(detailsLines || '')}</pre>
        ${wid ? `<div class="muted small" style="margin-top:6px;">ID wojny: <code>${escapeHtml(wid)}</code></div>` : ''}
      </td>`;

      btn.onclick = () => {
        const isOpen = detailsTr.style.display !== 'none';
        detailsTr.style.display = isOpen ? 'none' : '';
        btn.textContent = isOpen ? '▶' : '▼';
      };

      tr.innerHTML = `
        <td></td>
        <td>${escapeHtml(fmtDate(w.created_at_ts || 0))}</td>
        <td><span class="pill ${pillClass}">${escapeHtml(res)}</span></td>
        <td class="right">${escapeHtml((diff >= 0 ? '+' : '') + diff)}</td>
        <td>${escapeHtml(mode)}</td>
        <td class="right">${escapeHtml(w.our_score ?? '')}</td>
        <td>${escapeHtml(opp)}</td>
        <td class="right">${escapeHtml((w.opponent_score ?? w.enemy_score ?? '') + '')}</td>
        <td class="right">${oorN ? `<span class="pill warn">${oorN}</span>` : '0'}</td>
      `;
      tr.children[0].appendChild(btn);
      tbody.appendChild(tr);
      tbody.appendChild(detailsTr);
    }
  }

  function renderRosterAverages() {
    const wars = Array.isArray(window.__ALL_WARS__) ? window.__ALL_WARS__ : [];
    const roster = Array.isArray(window.__ROSTER__) ? window.__ROSTER__ : [];
    const sel = document.getElementById('avgX');
    const n = wars.length;
    sel.innerHTML = '';
    const max = Math.max(1, n);
    for (let i=1; i<=max; i++) {
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = String(i);
      sel.appendChild(opt);
    }
    sel.value = String(Math.min(5, max));

    let expanded = false;
    const render = () => {
      const x = Number(sel.value || 1);
      // Średnia ma być liczona z X NAJŚWIEŻSZYCH wojen (po dacie dodania screenów na Discordzie),
      // niezależnie od aktualnego sortowania/filtrów tabeli na stronie.
      const warsSorted = wars.slice().sort((a, b) => Number(b.created_at_ts || 0) - Number(a.created_at_ts || 0));
      const slice = warsSorted.slice(0, x);

      // For averages we count only wars where the player is present in the list.
      // (We do NOT divide by X if the player did not participate.)
      const statsByName = new Map();
      for (const name of roster) {
        statsByName.set(name, { sum: 0, count: 0 });
      }

      for (const w of slice) {
        const map = new Map();
        for (const p of (w.players || [])) {
          map.set(p.name, Number(p.points || 0));
        }
        for (const name of roster) {
          if (map.has(name)) {
            const pts = map.get(name) || 0;
            const s = statsByName.get(name);
            s.sum += pts;
            s.count += 1;
          }
        }
      }

      const rows = roster.map(name => {
        const s = statsByName.get(name) || { sum: 0, count: 0 };
        const avg = s.count ? (s.sum / s.count) : 0;
        return { name, avg, sum: s.sum, warsCount: s.count };
      }).sort((a,b)=> (b.avg - a.avg) || (b.sum - a.sum) || a.name.localeCompare(b.name));

      const top = rows.slice(0, 5);
      const rest = rows.slice(5);

      const tbody = document.querySelector('#rosterTable tbody');
      tbody.innerHTML = '';
      expanded = false;

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        if (idx >= 5) {
          tr.classList.add('more-row');
          tr.style.display = 'none';
        }
        tr.innerHTML = `
          <td>${escapeHtml(r.name)}</td>
          <td class="right">${r.avg.toFixed(1)}</td>
          <td class="right">${r.sum}</td>
          <td class="right">${r.warsCount}/${x}</td>
        `;
        tbody.appendChild(tr);
      });

      const btn = document.getElementById('rosterToggleBtn');
      if (rest.length > 0) {
        btn.style.display = '';
        btn.textContent = 'Pokaż więcej';
        btn.title = `Pokaż ${rest.length} pozostałych`;
        btn.onclick = () => {
          expanded = !expanded;
          document.querySelectorAll('#rosterTable tbody tr.more-row').forEach(tr => {
            tr.style.display = expanded ? '' : 'none';
          });
          btn.textContent = expanded ? 'Pokaż mniej' : 'Pokaż więcej';
        };
      } else {
        btn.style.display = 'none';
        btn.onclick = null;
      }
    };

    sel.onchange = render;
    render();
  }

  loadAll().catch(err => {
    console.error(err);
    document.getElementById('warsCount').textContent = 'Błąd ładowania danych.';
  });
</script>
</body>
</html>
